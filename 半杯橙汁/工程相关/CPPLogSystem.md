# CPPLogSystem

# 基本要求

日志系统一般分为前端（API）和后端（具体实现）

较为普遍的情形是，多个前端和一个后端，是一个多生产者，单消费者的情形

对于整个程序，日志系统应该统一，所以应该是一个单例模式(singleton)

# 功能需求

+ 日志级别(level)：必需项，且应该是在运行期间可以调整的。
+ 日志的输出位置(appender)：文件或者套接字等等fd
+ 日志的格式设置(layout)
+ 过滤器(filter)：控制不同组件的消息级别和目的地

对于分布式系统中的服务进程而言，目的地只能是本地文件。因为如果网络出现了问题会导致很多问题。如，日志服务器发生故障或者出现了死锁，此时会导致多个发送日志的服务进程阻塞，或者内存暴涨，这样子就放大了单机故障

如果是本地存储日志，那么就需要实现日志的滚动(rolling)，即到达指定大小或者时间就新建日志。在多线程中，尽量主动的rolling，否则处理SIGUSR1比较麻烦

推荐日志文件名：

```
logfile_name.time.hostname.pid.log
```

日志文件的压缩与归档，应该使用专门的脚本

日志系统也不应该关心磁盘空间的问题，如果限制大小，并且可以循环利用，那么可能出现一些问题无法进行排查。

日志库不能每条信息都flush，也不能每条信息都open/close，这样会极大降低程序的性能。解决方法：定期将缓冲区的日志flush；每条内存中的消息都带有cookie，值为某个函数的地址，这样可以从core dump文件中查找未写入日志的信息。

日志格式应该是固定的，节省解析格式的程序开销。需要注意的点：

+ 尽量每条消息占据一行，方便使用awk，sed，grep命令进行分析
+ 时间精确到微秒，使用gettimeofday(2)，该函数不会有性能损失，因为在x86上这不是一个系统调用
+ 使用GMT时区，可以省去本地时区转换的麻烦
+ 打印线程id，利于分析多线程，特别是死锁问题
+ 打印日志级别，文件名，行号，函数名等